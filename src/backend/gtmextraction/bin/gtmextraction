#!/usr/bin/env python3
import logging
import time
from threading import Thread

from gtmcore.data.db import Schema, TaskState
from gtmcore.data.db.err.tasknotexistserror import TaskNotExistsError
from gtmcore.data.db.results.task import Task
from gtmcore.logic.dbmanager import DBManager
from gtmextraction.logic.connections import GitHubConnection, GitHubManager
from gtmextraction.logic.connections.config.connconfiguration import \
    ConnConfiguration


class GTMExtraction():

    def __init__(self):
        config: ConnConfiguration = ConnConfiguration()
        schema: Schema = Schema()
        self.__db_manager: DBManager = DBManager(schema)
        self.__gh_conn: GitHubConnection = GitHubConnection()
        self.__gh_manager: GitHubManager = GitHubManager(
            self.__gh_conn, self.__db_manager)

        self.current_task: Task = None

    def run(self):
        logging.info("[GTMExtraction] Running...")
        while True:
            task = self.get_next_queued_task()
            if task and self.current_task is None:
                logging.debug(
                    "[GTMExtraction] NEW TASK FOUND. TASK_ID: %d | TASK_REPO: %s | CREATED AT: %s",
                    task.task_id, task.repo_dir, task.timestamp)

                self.__db_manager.set_task_state(
                    task.task_id, TaskState.CAPTURING_DATA)

                self.current_task = task
                Thread(target=self.capture_repo_data, args=(task,)).start()

                self.__db_manager.set_task_state(
                    task.task_id, TaskState.WAITING)

            time.sleep(10)

    def capture_repo_data(self, task: Task) -> bool:
        logging.debug(
            "[GTMExtraction] STARTING DATA EXTRACTION FROM REPO: %s", task.repo_dir)

        title, description, labels = self.__gh_manager.get_repo_info(
            task.repo_dir)
        self.__db_manager.create_repository(
            task.repo_dir, title, description, labels)

        issues_data = self.__gh_manager.get_repo_issues(
            task, self.check_is_task_outdated)

        if issues_data:
            for issue_data in issues_data:
                self.__db_manager.create_issue(
                    task.repo_dir,
                    issue_data["id"],
                    issue_data["title"],
                    issue_data["description"],
                    issue_data["labels"],
                    issue_data["comments"],
                    issue_data["is_pull_request"])

        self.current_task = None
        logging.debug(
            "[GTMExtraction] ENDING DATA EXTRACTION FROM REPO: %s", task.repo_dir)
        return True

    def check_is_task_outdated(self, old_task: Task):
        new_task: Task = self.__db_manager.get_lastest_task_from_repo(
            old_task.repo_dir)
        return old_task.timestamp != new_task.timestamp

    def get_next_queued_task(self) -> Task:
        try:
            return self.__db_manager.get_oldest_task_with_state(TaskState.QUEUED)
        except TaskNotExistsError:
            return None


if __name__ == "__main__":
    logging.basicConfig(filename="gtmextraction.log",
                        format="[%(levelname)s] %(asctime)s %(message)s",
                        datefmt="%m/%d/%Y %I:%M:%S %p", level=logging.DEBUG)
    logging.info("[GTMExtraction] INITIALIZING EXTRACTION MODULE... ")
    extractor = GTMExtraction()
    extractor.run()
